# =============================================================================
# k6 Load Testing Workflow
# =============================================================================
# Manual trigger to run k6 performance tests against Azure VM
# =============================================================================

name: k6 Load Tests

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        default: 'browsing-load'
        type: choice
        options:
          - seat-lock-concurrency
          - browsing-load
          - booking-workflow
          - spike-test
          - soak-test
          - all
      
      target_url:
        description: 'Target API URL (leave empty to use Azure VM)'
        required: false
        default: ''
        type: string
      
      vus:
        description: 'Virtual Users (overrides scenario default)'
        required: false
        default: ''
        type: string
      
      duration:
        description: 'Test duration (e.g., 30s, 5m)'
        required: false
        default: ''
        type: string

env:
  K6_WORKING_DIR: k6-tests

jobs:
  # ============================================
  # Run k6 Tests
  # ============================================
  k6-test:
    name: Run k6 - ${{ github.event.inputs.test_scenario }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Determine Target URL
        id: target
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
        run: |
          if [ -n "${{ github.event.inputs.target_url }}" ]; then
            echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
            echo "is_azure=false" >> $GITHUB_OUTPUT
          elif [ -n "$AZURE_VM_HOST" ]; then
            echo "url=http://$AZURE_VM_HOST:8080" >> $GITHUB_OUTPUT
            echo "is_azure=true" >> $GITHUB_OUTPUT
          else
            echo "url=http://localhost:8080" >> $GITHUB_OUTPUT
            echo "is_azure=false" >> $GITHUB_OUTPUT
          fi

      - name: Show Test Configuration
        run: |
          echo "=========================================="
          echo "k6 Test Configuration"
          echo "=========================================="
          echo "Scenario: ${{ github.event.inputs.test_scenario }}"
          echo "Target URL: ${{ steps.target.outputs.url }}"
          echo "Custom VUs: ${{ github.event.inputs.vus || 'default' }}"
          echo "Custom Duration: ${{ github.event.inputs.duration || 'default' }}"
          echo "=========================================="

      - name: Health Check
        continue-on-error: true
        run: |
          echo "Checking API availability at ${{ steps.target.outputs.url }}..."
          if curl -sf "${{ steps.target.outputs.url }}/api/v1/movies" --max-time 30 > /dev/null 2>&1; then
            echo "‚úÖ API is reachable"
          else
            echo "‚ö†Ô∏è API not ready yet (this is normal before DB reset)"
          fi

      - name: Setup SSH for VM Access
        if: steps.target.outputs.is_azure == 'true'
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AZURE_VM_SSH_KEY" > ~/.ssh/azure_vm_key
          chmod 600 ~/.ssh/azure_vm_key
          ssh-keyscan -H $AZURE_VM_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Reset Database Before Test
        if: steps.target.outputs.is_azure == 'true'
        env:
          AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          AZURE_VM_USERNAME: ${{ secrets.AZURE_VM_USERNAME }}
        run: |
          echo "=========================================="
          echo "üîÑ Resetting Database for Clean Test State"
          echo "=========================================="
          
          ssh -i ~/.ssh/azure_vm_key -o StrictHostKeyChecking=no \
            $AZURE_VM_USERNAME@$AZURE_VM_HOST << 'ENDSSH'
            cd /opt/moviebooking
            
            echo "Stopping application container..."
            sudo docker compose stop moviebooking-app
            
            echo "Dropping and recreating database..."
            sudo docker compose exec -T db psql -U postgres -c "DROP DATABASE IF EXISTS moviebooking;"
            sudo docker compose exec -T db psql -U postgres -c "CREATE DATABASE moviebooking;"
            
            echo "Restarting application with ddl-auto=create..."
            sudo docker compose up -d moviebooking-app
            
            echo "Waiting for application to initialize (60s)..."
            sleep 60
            
            echo "‚úÖ Database reset complete"
          ENDSSH
          
          echo "Verifying API is ready..."
          for i in {1..20}; do
            if curl -sf "${{ steps.target.outputs.url }}/api/v1/movies" --max-time 10 > /dev/null 2>&1; then
              echo "‚úÖ API is ready"
              exit 0
            fi
            echo "Waiting for API to initialize... (attempt $i/20)"
            sleep 10
          done
          
          echo "‚ùå API failed to become ready after 200 seconds"
          echo "Checking Docker container status..."
          ssh -i ~/.ssh/azure_vm_key -o StrictHostKeyChecking=no \
            $AZURE_VM_USERNAME@$AZURE_VM_HOST "cd /opt/moviebooking && sudo docker compose ps && sudo docker compose logs --tail=50 moviebooking-app"
          exit 1

      - name: Run k6 Test - Seat Lock Concurrency
        if: ${{ github.event.inputs.test_scenario == 'seat-lock-concurrency' || github.event.inputs.test_scenario == 'all' }}
        working-directory: ${{ env.K6_WORKING_DIR }}
        run: |
          k6 run \
            -e API_URL=${{ steps.target.outputs.url }} \
            -e K6_PROMETHEUS_REMOTE_WRITE_URL=${{ steps.target.outputs.url }}:9090/api/v1/write \
            ${{ github.event.inputs.vus && format('--vus {0}', github.event.inputs.vus) || '' }} \
            ${{ github.event.inputs.duration && format('--duration {0}', github.event.inputs.duration) || '' }} \
            --out experimental-prometheus-rw \
            --out json=results-seat-lock.json \
            --summary-export=summary-seat-lock.json \
            scenarios/01-seat-lock-concurrency.js

      - name: Run k6 Test - Browsing Load
        if: ${{ github.event.inputs.test_scenario == 'browsing-load' || github.event.inputs.test_scenario == 'all' }}
        working-directory: ${{ env.K6_WORKING_DIR }}
        run: |
          k6 run \
            -e API_URL=${{ steps.target.outputs.url }} \
            -e K6_PROMETHEUS_REMOTE_WRITE_URL=${{ steps.target.outputs.url }}:9090/api/v1/write \
            ${{ github.event.inputs.vus && format('--vus {0}', github.event.inputs.vus) || '' }} \
            ${{ github.event.inputs.duration && format('--duration {0}', github.event.inputs.duration) || '' }} \
            --out experimental-prometheus-rw \
            --out json=results-browsing.json \
            --summary-export=summary-browsing.json \
            scenarios/02-browsing-load.js

      - name: Run k6 Test - Booking Workflow
        if: ${{ github.event.inputs.test_scenario == 'booking-workflow' || github.event.inputs.test_scenario == 'all' }}
        working-directory: ${{ env.K6_WORKING_DIR }}
        run: |
          k6 run \
            -e API_URL=${{ steps.target.outputs.url }} \
            -e K6_PROMETHEUS_REMOTE_WRITE_URL=${{ steps.target.outputs.url }}:9090/api/v1/write \
            ${{ github.event.inputs.vus && format('--vus {0}', github.event.inputs.vus) || '' }} \
            ${{ github.event.inputs.duration && format('--duration {0}', github.event.inputs.duration) || '' }} \
            --out experimental-prometheus-rw \
            --out json=results-booking.json \
            --summary-export=summary-booking.json \
            scenarios/03-booking-workflow.js

      - name: Run k6 Test - Spike Test
        if: ${{ github.event.inputs.test_scenario == 'spike-test' || github.event.inputs.test_scenario == 'all' }}
        working-directory: ${{ env.K6_WORKING_DIR }}
        run: |
          k6 run \
            -e API_URL=${{ steps.target.outputs.url }} \
            -e K6_PROMETHEUS_REMOTE_WRITE_URL=${{ steps.target.outputs.url }}:9090/api/v1/write \
            --out experimental-prometheus-rw \
            --out json=results-spike.json \
            --summary-export=summary-spike.json \
            scenarios/04-spike-test.js

      - name: Run k6 Test - Soak Test
        if: ${{ github.event.inputs.test_scenario == 'soak-test' }}
        working-directory: ${{ env.K6_WORKING_DIR }}
        run: |
          k6 run \
            -e API_URL=${{ steps.target.outputs.url }} \
            -e K6_PROMETHEUS_REMOTE_WRITE_URL=${{ steps.target.outputs.url }}:9090/api/v1/write \
            --out experimental-prometheus-rw \
            --out json=results-soak.json \
            --summary-export=summary-soak.json \
            scenarios/05-soak-test.js

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results-${{ github.event.inputs.test_scenario }}-${{ github.run_number }}
          path: |
            ${{ env.K6_WORKING_DIR }}/results-*.json
            ${{ env.K6_WORKING_DIR }}/summary-*.json
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä k6 Test Complete!"
          echo "=========================================="
          echo "Scenario: ${{ github.event.inputs.test_scenario }}"
          echo "Target: ${{ steps.target.outputs.url }}"
          echo ""
          echo "Results uploaded as artifact:"
          echo "  k6-results-${{ github.event.inputs.test_scenario }}-${{ github.run_number }}"
          echo "=========================================="
