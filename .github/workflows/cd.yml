# =============================================================================
# CD Workflow - Deploy MovieBooking to Azure VM
# =============================================================================
# Runs: After Terraform Apply, or manually
# =============================================================================

name: CD - Deploy to Azure

on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for VM
        run: |
          echo "Waiting 60s for VM cloud-init..."
          sleep 60

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          command_timeout: 15m
          script: |
            echo "=========================================="
            echo "Starting MovieBooking deployment..."
            echo "=========================================="
            
            # Ensure Docker is in PATH and running
            export PATH=$PATH:/usr/bin:/usr/local/bin
            
            # Wait for cloud-init to complete (in case VM just started)
            echo "Waiting for cloud-init to complete..."
            sudo cloud-init status --wait || true
            
            # Ensure Docker is running
            echo "Ensuring Docker is running..."
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
            
            # Install Docker if missing
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              rm get-docker.sh
            fi
            
            # Check if app directory exists and is a valid git repo
            if [ -d "/opt/moviebooking/.git" ]; then
              echo "Repository already exists. Pulling latest code..."
              cd /opt/moviebooking
              git fetch origin
              git checkout ${{ github.ref_name }} || git checkout main
              git pull
            else
              echo "Cloning repository for the first time..."
              sudo rm -rf /opt/moviebooking
              sudo mkdir -p /opt/moviebooking
              sudo chown $USER:$USER /opt/moviebooking
              git clone https://github.com/${{ github.repository }}.git /opt/moviebooking
              cd /opt/moviebooking
              git checkout ${{ github.ref_name }} || git checkout main
            fi
            
            cd /opt/moviebooking/backend
            
            # Verify we're in the right directory with docker-compose.yml
            if [ ! -f "docker-compose.yml" ]; then
              echo "❌ ERROR: docker-compose.yml not found in $(pwd)"
              echo "Contents of current directory:"
              ls -la
              exit 1
            fi
            
            echo "✅ Repository ready at $(pwd)"
            
            # Create .env file if it doesn't exist
            if [ ! -f ".env" ]; then
              echo "Creating .env file..."
              cat > .env << 'ENVEOF'
            SPRING_PROFILES_ACTIVE=dev
            DB_HOST=db
            DB_PORT=5432
            DB_NAME=moviebooking
            DB_USERNAME=postgres
            DB_PASSWORD=postgres
            REDIS_HOST=redis
            REDIS_PORT=6379
            ENVEOF
            fi
            
            # Build and start services
            echo "Starting Docker Compose services..."
            sudo docker compose down --remove-orphans || true
            sudo docker compose up -d --build
            
            # Wait for services to start
            echo "Waiting for services to start..."
            sleep 60
            
            # Show current status
            echo "=========================================="
            echo "Current service status:"
            echo "=========================================="
            sudo docker compose ps
            
            # Show logs for main service
            echo ""
            echo "=========================================="
            echo "Service Logs (last 30 lines):"
            echo "=========================================="
            sudo docker compose logs --tail=30 moviebooking 2>/dev/null || echo "No logs yet"
            
            echo ""
            echo "✅ Deployment complete!"

      - name: Health Check
        run: |
          VM_HOST="${{ secrets.AZURE_VM_HOST }}"
          API_URL="http://${VM_HOST}:8080"
          
          echo "Waiting 30s for services..."
          sleep 30
          
          echo "Checking API health..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${API_URL}/api/v1/movies" 2>/dev/null || echo "000")
          
          if [ "$HTTP_STATUS" = "000" ]; then
            echo "⚠️ API not responding yet - may still be starting"
          elif [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ API is healthy!"
          else
            echo "API responded with status $HTTP_STATUS"
          fi
          
          echo ""
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo "API: ${API_URL}"
          echo "Swagger: ${API_URL}/swagger-ui.html"
          echo "=========================================="
