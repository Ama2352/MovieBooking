# =============================================================================
# CD Workflow - Deploy MovieBooking to Azure VM
# =============================================================================
# Runs: After Terraform Apply, or manually
# =============================================================================

name: CD - Deploy to Azure

on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for VM
        run: |
          echo "Waiting 60s for VM cloud-init..."
          sleep 60

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          command_timeout: 15m
          script: |
            echo "=========================================="
            echo "Starting MovieBooking deployment..."
            echo "=========================================="
            
            # Ensure Docker is in PATH and running
            export PATH=$PATH:/usr/bin:/usr/local/bin
            
            # Wait for cloud-init to complete (in case VM just started)
            echo "Waiting for cloud-init to complete..."
            sudo cloud-init status --wait || true
            
            # Ensure Docker is running
            echo "Ensuring Docker is running..."
            sudo systemctl start docker || true
            sudo systemctl enable docker || true
            
            # Install Docker if missing
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              rm get-docker.sh
            fi
            
            # Force fresh clone to ensure correct structure
            echo "Removing old deployment directory..."
            sudo rm -rf /opt/moviebooking
            
            echo "Cloning repository fresh..."
            sudo mkdir -p /opt/moviebooking
            sudo chown $USER:$USER /opt/moviebooking
            git clone https://github.com/${{ github.repository }}.git /opt/moviebooking
            cd /opt/moviebooking
            git checkout ${{ github.ref_name }} || git checkout main
            
            # Verify we're in the right directory with docker-compose.yml
            echo "Current directory: $(pwd)"
            echo "Contents:"
            ls -la
            
            if [ ! -f "docker-compose.yml" ]; then
              echo "❌ ERROR: docker-compose.yml not found in $(pwd)"
              exit 1
            fi
            
            echo "✅ Repository ready at $(pwd)"
            
            # Create backend/.env file (required by docker-compose.yml)
            # This activates the prod profile and provides all required secrets
            echo "Creating backend/.env file..."
            mkdir -p backend
            cat > backend/.env << EOF
            # Spring Profile - activates application-prod.properties
            SPRING_PROFILES_ACTIVE=prod
            
            # Database (PostgreSQL) - used by both postgres container and Spring
            POSTGRES_DB=moviebooking
            POSTGRES_USER=postgres
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            
            # Spring datasource (connects to 'db' service in docker network)
            SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/moviebooking
            
            # JWT Secret
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            
            # Google OAuth2
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            
            # Redis (connects to 'redis' service in docker network)
            SPRING_DATA_REDIS_HOST=redis
            SPRING_DATA_REDIS_PORT=6379
            SPRING_DATA_REDIS_TIMEOUT=60000
            
            # Seat Lock Config
            SEAT_LOCK_DURATION_MINUTES=10
            SEAT_LOCK_MAX_SEATS_PER_BOOKING=10
            
            # PayPal
            PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}
            PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}
            PAYPAL_MODE=sandbox
            
            # MoMo
            MOMO_PARTNER_CODE=${{ secrets.MOMO_PARTNER_CODE }}
            MOMO_ACCESS_KEY=${{ secrets.MOMO_ACCESS_KEY }}
            MOMO_SECRET_KEY=${{ secrets.MOMO_SECRET_KEY }}
            EOF
            
            # Remove leading whitespace from .env file (heredoc issue)
            sed -i 's/^[[:space:]]*//' backend/.env
            
            echo "✅ backend/.env created with prod profile"
            echo "Contents:"
            cat backend/.env | grep -v SECRET | grep -v PASSWORD | grep -v KEY
            
            # Build and start services
            echo "Starting Docker Compose services..."
            sudo docker compose down --remove-orphans || true
            sudo docker compose up -d --build
            
            # Wait for services to start
            echo "Waiting for services to start..."
            sleep 60
            
            # Show current status
            echo "=========================================="
            echo "Current service status:"
            echo "=========================================="
            sudo docker compose ps
            
            # Show logs for main service
            echo ""
            echo "=========================================="
            echo "Service Logs (last 30 lines):"
            echo "=========================================="
            sudo docker compose logs --tail=30 moviebooking 2>/dev/null || echo "No logs yet"
            
            echo ""
            echo "✅ Deployment complete!"

      - name: Health Check
        run: |
          VM_HOST="${{ secrets.AZURE_VM_HOST }}"
          API_URL="http://${VM_HOST}:8080"
          
          echo "Waiting 30s for services..."
          sleep 30
          
          echo "Checking API health..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${API_URL}/api/v1/movies" 2>/dev/null || echo "000")
          
          if [ "$HTTP_STATUS" = "000" ]; then
            echo "⚠️ API not responding yet - may still be starting"
          elif [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ API is healthy!"
          else
            echo "API responded with status $HTTP_STATUS"
          fi
          
          echo ""
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo "API: ${API_URL}"
          echo "Swagger: ${API_URL}/swagger-ui.html"
          echo "=========================================="
