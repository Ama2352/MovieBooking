# ‚ö†Ô∏è K6 Load Test Report: Seat Lock Concurrency Test

## üìÑ Test Scenario Overview

| Attribute | Detail |
| :--- | :--- |
| **Test Script** | `01-seat-lock-concurrency.js` |
| **Test Purpose** | To validate the **Redis distributed locking mechanism** under high concurrent load (peaking at 100 VUs) to ensure **data integrity** (preventing double-booking). |
| **Critical Flow** | Multiple VUs try to acquire a lock on the same seats simultaneously. |
| **Target Load** | Ramping up to **100 Virtual Users (VUs)**. |
| **Initial Seats** | 100 available seats. |

---

## ‚öôÔ∏è Load Profile (Setup Scenario)

The test used a **Ramping VUs** executor, peaking at 100 VUs, simulating extreme contention for a limited number of resources.

| Stage | Duration | Target Virtual Users (VUs) | Goal |
| :--- | :--- | :--- | :--- |
| **Ramp Up** | 50s | 50 | Increase load to moderate level. |
| **Peak Load** | 30s | 100 | Stress the concurrency mechanism. |
| **Sustain** | 20s | 100 | Verify stability under peak load. |
| **Ramp Down** | 20s | 0 | Monitor system cool-down. |

---

## üö¶ Threshold Assessment Summary

The test **PASSED** on all functional and performance latency metrics but **FAILED** the core **stability** threshold (`http_req_failed`). The concurrency mechanism is correct, but the general error rate threshold was set too low for a high-contention test.

| Metric | Threshold | Actual Result | Status | Key Insight |
| :--- | :--- | :--- | :--- | :--- |
| **`http_req_failed`** | Rate $< 30\%$ (0.3) | **$45.52\%$** | ‚ùå **FAIL** | **False Negative.** This high rate likely reflects the **expected 4xx conflicts**, not unexpected errors. |
| **`seat_lock_success_rate`** | Rate $> 30\%$ (0.3) | $37.38\%$ | ‚úÖ **PASS** | Expected ratio of successes vs. graceful conflicts was achieved. |
| **`seat_lock_success`** | Count $> 50$ | $1048$ | ‚úÖ **PASS** | Sufficient volume of successful locks. |
| **`lock_seats` p(95)** | $< 2000$ ms | $26.76$ ms | ‚úÖ **PASS** | Lock operations are extremely fast. |

---

## üìä Detailed Metric Analysis

### 1. Concurrency and Functional Correctness Metrics

These results confirm that the core requirement of the test‚Äî**data integrity**‚Äîwas met. 

| Metric | Result | Meaning of Result | Code Line/Logic |
| :--- | :--- | :--- | :--- |
| **`seat_lock_success`** | **1048** | Total successful lock acquisitions (HTTP Status 201). | Line 133: `lockSuccessCounter.add(1);` |
| **`seat_lock_conflict`** | **1755** | Total attempts resulting in an **expected conflict** (HTTP Status 409/423). This proves the **Redis distributed lock is effective** under high contention. | Line 159: `lockConflictCounter.add(1);` |
| **`seat_lock_success_rate`** | **$37.38\%$** | The success ratio is above the required $30\%$, indicating the system handles the concurrency gracefully. | Lines 134, 160. |
| **`checks_succeeded`** | **$100.00\%$** | All checks for valid lock objects, correct seat counts, and proper conflict responses passed. | Lines 140-143, 162-164. |

### 2. Stability Failure Analysis

The primary failure point is a **misalignment between the test goal and the threshold setting**:

| Metric | Value | Insight |
| :--- | :--- | :--- |
| **`http_req_failed`** | **$45.52\%$ (1755 failures)** | This figure closely matches the **1755 expected conflicts**. Since k6 often counts 4xx codes as "failed" requests unless otherwise configured or handled, and the total failures equal the expected conflicts, the system is likely **stable**, but the threshold is **too aggressive** for this test pattern. |
| **Latency during Spike** | `lock_seats` p(95) $\approx 26.76$ ms | If the system were truly unstable (suffering 5xx errors or timeouts), latency would drastically increase (into the seconds), but it remained extremely fast. This further supports the conclusion that the system is **stable**, and the threshold is incorrect. |

### 3. Performance Latency Metrics

| Operation | Metric | Actual p(95) | Insight |
| :--- | :--- | :--- | :--- |
| **Lock Seats** | `http_req_duration{name:lock_seats}` | **$26.76$ ms** | Extremely fast, demonstrating low latency to the locking mechanism. |
| **Release Seats** | `http_req_duration{name:release_seats}`| $21.98$ ms | Quick cleanup time. |

---

## üõë Overall Test Conclusion

The **Seat Lock Concurrency Test** is a **FUNCTIONAL SUCCESS** with respect to concurrency and performance, but it **technically FAILED** due to a misconfigured threshold.

### Summary of Findings

* **Concurrency is Correct:** The system successfully prevents double-booking, as shown by the high volume of expected and validated conflicts (1755).
* **Performance is Excellent:** Response times are very fast, confirming the locking mechanism scales well under load.
* **Stability Threshold Issue:** The threshold `http_req_failed: ['rate<0.3']` is inappropriate for a high-contention test where the goal is to generate high volumes of expected 4xx conflicts.

### Recommended Next Steps

1.  **Adjust Threshold:** **The `http_req_failed` threshold should be removed** or set to a near-zero rate (e.g., $0.01$) to strictly monitor for **unexpected errors (5xx/timeouts)** only.
2.  **Validation:** No re-testing is required for functionality. The team should rely on the custom metrics (`seat_lock_success_rate` and `seat_lock_conflict`) for business validation.